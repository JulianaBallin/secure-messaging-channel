# ğŸ” LÃ³gica Geral do Sistema de ComunicaÃ§Ã£o â€” CipherTalk

## ğŸ§© VisÃ£o Geral

O CipherTalk Ã© um sistema de **comunicaÃ§Ã£o segura ponta a ponta (E2EE)** baseado em **criptografia hÃ­brida**:
- RSA (assimÃ©trica): usada para troca segura de chaves IDEA.
- IDEA (simÃ©trica): usada para criptografar o conteÃºdo real das mensagens.

A seguranÃ§a e escalabilidade do sistema se baseiam em trÃªs pilares:
1. **Criptografia ponta a ponta (E2EE)** â€” o servidor nunca lÃª as mensagens.
2. **Gerenciamento seguro de chaves** â€” cada conversa (par ou grupo) possui uma chave IDEA Ãºnica.
3. **PersistÃªncia auditÃ¡vel** â€” histÃ³rico criptografado armazenado no banco SQLite, com logs de auditoria.

---

## ğŸ’¬ ComunicaÃ§Ã£o entre 2 UsuÃ¡rios (Chat Privado)

### ğŸ”„ Fluxo BÃ¡sico

1. **AutenticaÃ§Ã£o**
   - UsuÃ¡rio A e UsuÃ¡rio B fazem login (via `handle_login`) e recebem token JWT.
   - Cada um tem um par RSA (privada local, pÃºblica no servidor).

2. **Troca de Chaves**
   - UsuÃ¡rio A gera uma chave IDEA aleatÃ³ria para a conversa.
   - Essa chave Ã© criptografada com a **chave pÃºblica RSA de B** e enviada junto Ã  mensagem.

3. **Criptografia e Envio**
   - A mensagem Ã© criptografada localmente com IDEA (CBC + PKCS7).
   - O pacote enviado ao servidor contÃ©m:
     ```json
     {
       "to": "UsuarioB",
       "content_encrypted": "<mensagem_criptografada>",
       "key_encrypted": "<chave_IDEA_criptografada_com_RSA>",
       "timestamp": "2025-10-09T14:35:00Z"
     }
     ```
   - O servidor apenas **roteia ou armazena** a mensagem â€” **nunca descriptografa.**

4. **Recebimento**
   - UsuÃ¡rio B recebe o pacote, descriptografa a chave IDEA com sua chave privada RSA.
   - Em seguida, descriptografa a mensagem com essa chave IDEA.

5. **PersistÃªncia**
   - O servidor salva no banco (`messages`):
     - `sender_id`, `receiver_id`
     - `content_encrypted`
     - `key_encrypted`
     - `timestamp`
   - Tudo Ã© armazenado **criptografado**, garantindo confidencialidade.

---

## ğŸ‘¥ ComunicaÃ§Ã£o em Grupo (Chats Coletivos)

### âš™ï¸ Estrutura e SeguranÃ§a

Cada grupo funciona como uma **instÃ¢ncia independente de sessÃ£o IDEA**, gerenciada por um **admin**.  
O servidor **nÃ£o gera chaves** â€” apenas distribui e armazena mensagens criptografadas.

### ğŸ§± Fluxo de CriaÃ§Ã£o e Gerenciamento

1. **CriaÃ§Ã£o do Grupo**
   - UsuÃ¡rio criador se torna **admin** por padrÃ£o.
   - Uma chave IDEA Ãºnica do grupo Ã© gerada **no cliente do admin**.
   - Essa chave Ã© criptografada com a chave pÃºblica de cada novo membro.

2. **Entrada de Novo Membro**
   - Apenas o **admin** pode adicionar usuÃ¡rios.
   - Ao adicionar um novo membro:
     - A chave IDEA do grupo Ã© criptografada com a chave RSA pÃºblica do novo membro.
     - O membro passa a receber mensagens cifradas com essa chave.

3. **Envio de Mensagem**
   - Cada mensagem do grupo contÃ©m:
     - `group_id`, `content_encrypted`, `keys_encrypted` (um dicionÃ¡rio `{user: chave_RSA_cifrada}`)
   - O servidor envia individualmente a cada membro:
     - Mensagem cifrada + chave IDEA cifrada para aquele membro.

4. **SaÃ­da de Membro**
   - Qualquer membro (nÃ£o admin) pode sair livremente.
   - Se o **admin sair**, o sistema deve:
     - Promover outro membro automaticamente (`transfer_group_admin`).
     - Gerar uma **nova chave IDEA do grupo**.
     - Recriptografar e distribuir a nova chave aos membros restantes.

5. **Troca de Chaves**
   - Sempre que um membro entra ou sai:
     - O admin **gera uma nova chave IDEA**.
     - A chave antiga Ã© invalidada.
     - Cada novo membro recebe a nova chave via RSA.
   - Garante sigilo mesmo se um ex-membro mantiver o histÃ³rico antigo.

6. **RemoÃ§Ã£o de Grupo**
   - Se todos os membros saÃ­rem, o grupo Ã© removido automaticamente (`delete_empty_groups`).
   - Logs registram o evento com tag `[GROUP_REMOVE]`.

---

## ğŸ” EstratÃ©gia de Criptografia e Logs

### ğŸ“¦ Criptografia HÃ­brida
| Etapa | Algoritmo | DescriÃ§Ã£o |
|-------|------------|-----------|
| Troca de chave | RSA (PKCS1_OAEP) | Garante sigilo da chave IDEA. |
| Mensagem | IDEA (CBC + PKCS7) | RÃ¡pida e segura para texto. |
| Armazenamento | Base64 + SQLite | PersistÃªncia criptografada. |

### ğŸªµ Logs e Auditoria
- **database.log** â€” operaÃ§Ãµes de leitura e gravaÃ§Ã£o SQL.
- **crypto.log** â€” geraÃ§Ã£o, cifragem e falhas IDEA/RSA.
- **server.log** â€” conexÃµes, entregas, desconexÃµes e erros.
- **[AUDIT]** tags no CLI (`run_queries.py`) para consultas de verificaÃ§Ã£o.

---

## ğŸ§­ Regras de SeguranÃ§a e Escalabilidade

- ğŸ”’ **E2EE garantido** â€” o servidor nunca acessa o conteÃºdo das mensagens.
- âš¡ **MultiusuÃ¡rio** â€” mÃºltiplos usuÃ¡rios simultÃ¢neos por TLS.
- ğŸ—„ï¸ **Mensagens Offline** â€” entregues automaticamente no prÃ³ximo login.
- ğŸ” **RotaÃ§Ã£o de Chaves IDEA** â€” a cada mudanÃ§a de grupo.
- ğŸš« **Servidor neutro** â€” nunca gera nem descriptografa chaves.
- ğŸ§© **Logs imutÃ¡veis** â€” cada aÃ§Ã£o importante Ã© registrada para auditoria.

---

## ğŸ§® Exemplo de Fluxos Simplificados

### ğŸ”¹ Chat Privado
- [A] â†’ Gera IDEA â†’ Cifra mensagem â†’ Envia ao servidor
Servidor â†’ Roteia (nÃ£o lÃª)
- [B] â†’ Decifra RSA â†’ Decifra IDEA â†’ Exibe mensagem


### ğŸ”¹ Chat em Grupo
- Admin â†’ Gera IDEA â†’ Cria grupo â†’ Envia chaves via RSA
- Membros â†’ Recebem chaves IDEA â†’ Participam da conversa
- Quando um sai â†’ Admin gera nova chave IDEA â†’ Redistribui
- Servidor â†’ Armazena tudo criptografado

---

## âœ… BenefÃ­cios da Arquitetura

- Nenhuma chave ou mensagem trafega em texto claro.  
- Total conformidade com princÃ­pios de **privacidade e confidencialidade**.  
- Escalabilidade horizontal (suporta mÃºltiplos grupos simultÃ¢neos).  
- Auditoria detalhada via logs e CLI.  
- Estrutura modular â€” permite evoluÃ§Ã£o para interface web ou mobile no futuro.
